# CT BLE Devices 集成自动更新方案

## 方案概述

Home Assistant 自定义集成有多种自动更新方案，根据使用场景和需求选择合适的方式。

## 方案一：HACS（Home Assistant Community Store）⭐ 推荐

### 优点
- ✅ 用户友好，图形界面操作
- ✅ 自动检查更新
- ✅ 一键更新
- ✅ 支持版本管理
- ✅ 社区标准方案

### 实现步骤

#### 1. 准备 HACS 集成信息

创建 `hacs.json` 文件：

```json
{
  "name": "CT BLE Devices",
  "render_readme": true,
  "domains": ["sensor"],
  "iot_class": "Local Push"
}
```

#### 2. 更新 `manifest.json`

确保包含必要的元数据：

```json
{
  "domain": "ct_ble_devices",
  "name": "CT BLE Devices",
  "codeowners": ["@yourusername"],
  "config_flow": true,
  "dependencies": [],
  "documentation": "https://github.com/yourusername/ct_ble_devices",
  "iot_class": "local_push",
  "requirements": [
    "bleak>=0.21.0"
  ],
  "version": "1.0.0"
}
```

#### 3. GitHub 仓库要求

- 仓库必须是公开的
- 使用语义化版本（Semantic Versioning）
- 创建 Releases 标签（如 `v1.0.0`）
- 添加 `README.md` 文档

#### 4. 提交到 HACS

1. 在 HACS 中点击 "自定义仓库"
2. 添加仓库 URL
3. 选择类别：集成（Integration）
4. 用户即可通过 HACS 安装和更新

### 版本管理

使用 Git 标签管理版本：

```bash
# 创建版本标签
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# 更新版本
git tag -a v1.0.1 -m "Release version 1.0.1"
git push origin v1.0.1
```

## 方案二：自定义更新检查器

### 实现原理

在集成启动时检查 GitHub 最新版本，提示用户更新。

### 实现代码

在 `__init__.py` 中添加：

```python
import aiohttp
import logging
from packaging import version

_LOGGER = logging.getLogger(__name__)

async def check_update(hass: HomeAssistant, current_version: str):
    """检查是否有新版本可用"""
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(
                "https://api.github.com/repos/yourusername/ct_ble_devices/releases/latest",
                timeout=aiohttp.ClientTimeout(total=10)
            ) as response:
                if response.status == 200:
                    data = await response.json()
                    latest_version = data.get("tag_name", "").lstrip("v")
                    
                    if version.parse(latest_version) > version.parse(current_version):
                        _LOGGER.warning(
                            "新版本可用: %s (当前版本: %s). "
                            "请访问 https://github.com/yourusername/ct_ble_devices 更新",
                            latest_version,
                            current_version
                        )
                        # 可选：发送通知
                        from homeassistant.components import persistent_notification
                        persistent_notification.create(
                            hass,
                            f"CT BLE Devices 有新版本可用: {latest_version}\n"
                            f"当前版本: {current_version}\n"
                            "请手动更新集成。",
                            "CT BLE Devices 更新",
                            "ct_ble_devices_update"
                        )
    except Exception as e:
        _LOGGER.debug("检查更新失败: %s", e)

async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Set up ct_ble_devices from a config entry."""
    # ... 现有代码 ...
    
    # 检查更新（异步执行，不阻塞启动）
    current_version = hass.data[DOMAIN].get("version", "1.0.0")
    hass.async_create_task(check_update(hass, current_version))
    
    return True
```

### 优点
- ✅ 自动检查更新
- ✅ 不依赖 HACS
- ✅ 可自定义更新逻辑

### 缺点
- ❌ 需要手动下载更新
- ❌ 需要用户手动替换文件

## 方案三：Git 自动拉取（适用于开发环境）

### 实现原理

使用 Git 命令自动拉取最新代码。

### 实现代码

创建 `update.py`：

```python
import subprocess
import logging
from pathlib import Path

_LOGGER = logging.getLogger(__name__)

def update_integration():
    """使用 Git 拉取最新代码"""
    integration_path = Path(__file__).parent
    
    try:
        # 检查是否为 Git 仓库
        result = subprocess.run(
            ["git", "rev-parse", "--git-dir"],
            cwd=integration_path,
            capture_output=True,
            check=False
        )
        
        if result.returncode != 0:
            _LOGGER.warning("当前目录不是 Git 仓库")
            return False
        
        # 拉取最新代码
        subprocess.run(
            ["git", "pull", "origin", "main"],
            cwd=integration_path,
            check=True
        )
        
        _LOGGER.info("集成已更新，请重启 Home Assistant")
        return True
        
    except subprocess.CalledProcessError as e:
        _LOGGER.error("Git 更新失败: %s", e)
        return False
```

### 使用场景
- 开发环境
- 本地部署
- 需要频繁更新

### 缺点
- ❌ 需要 Git 环境
- ❌ 不适合生产环境
- ❌ 可能影响稳定性

## 方案四：Home Assistant 集成更新 API（高级）

### 实现原理

使用 Home Assistant 的集成更新机制，通过 API 检查更新。

### 实现代码

```python
from homeassistant.loader import async_get_integration

async def check_integration_update(hass: HomeAssistant):
    """检查集成更新"""
    try:
        integration = await async_get_integration(hass, DOMAIN)
        # 检查是否有更新可用
        # 注意：这需要集成在 Home Assistant 的集成仓库中
    except Exception as e:
        _LOGGER.debug("检查集成更新失败: %s", e)
```

### 限制
- 仅适用于官方集成仓库中的集成
- 自定义集成通常不适用

## 方案五：使用 updater 组件（简单方案）

### 实现原理

在集成中添加更新检查服务。

### 实现代码

在 `__init__.py` 中添加服务：

```python
from homeassistant.helpers import service

async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Set up ct_ble_devices from a config entry."""
    # ... 现有代码 ...
    
    async def handle_check_update(call):
        """处理检查更新服务调用"""
        await check_update(hass, "1.0.0")
    
    hass.services.async_register(DOMAIN, "check_update", handle_check_update)
    
    return True
```

用户可以通过服务调用检查更新：

```yaml
service: ct_ble_devices.check_update
```

## 推荐方案对比

| 方案 | 易用性 | 自动化程度 | 适用场景 | 推荐度 |
|------|--------|-----------|---------|--------|
| HACS | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 生产环境 | ⭐⭐⭐⭐⭐ |
| 自定义更新检查器 | ⭐⭐⭐ | ⭐⭐⭐ | 需要提示但不自动更新 | ⭐⭐⭐⭐ |
| Git 自动拉取 | ⭐⭐ | ⭐⭐⭐⭐⭐ | 开发环境 | ⭐⭐⭐ |
| HA 集成更新 API | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 官方集成 | ⭐⭐ |
| updater 组件 | ⭐⭐⭐ | ⭐⭐ | 简单场景 | ⭐⭐⭐ |

## 最佳实践建议

### 1. 版本管理
- 使用语义化版本（Semantic Versioning）
- 在 `manifest.json` 中更新版本号
- 使用 Git 标签标记版本

### 2. 更新日志
- 维护 `CHANGELOG.md` 文件
- 在 GitHub Releases 中详细说明更新内容

### 3. 兼容性
- 确保新版本向后兼容
- 提供迁移指南（如需要）

### 4. 测试
- 在测试环境验证更新流程
- 确保更新后集成正常工作

## 实施步骤（HACS 方案）

1. **准备 GitHub 仓库**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/yourusername/ct_ble_devices.git
   git push -u origin main
   ```

2. **创建第一个 Release**
   - 在 GitHub 上创建 Release
   - 标签：`v1.0.0`
   - 标题：`v1.0.0`
   - 描述：更新内容

3. **添加 HACS 支持文件**
   - 创建 `hacs.json`
   - 确保 `manifest.json` 完整

4. **提交到 HACS**
   - 用户通过 HACS 添加自定义仓库
   - 安装和更新

## 注意事项

1. **版本号格式**：必须符合语义化版本（如 `1.0.0`）
2. **Git 标签**：必须使用 `v` 前缀（如 `v1.0.0`）
3. **README.md**：HACS 会显示 README 内容
4. **稳定性**：确保更新不会破坏现有配置
5. **回滚**：提供回滚到旧版本的方法

---

**推荐方案**：使用 **HACS**，这是 Home Assistant 社区最常用和最可靠的方案。

